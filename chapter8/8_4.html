<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=windows-1251">
		<meta name="Description" content="K&R, 1st ed., 1978. Russian translation by <unknown>; chm-compiling by Sim&C, Belarus`2006">
   		<title>8.4 Произвольный доступ - seek и lseek</title>
		<link href="../style.css" rel="stylesheet" type="text/css" media="all">
	</head>

	<body>
	<script  language=JavaScript  src="../header.js"></script>
	<pre>    Нормально при работе с файлами ввод и вывод осуществля-
ется последовательно: при каждом обращении к функциям read и
write чтение или запись начинаются с позиции, непосредствен-
но следующей за предыдущей обработанной. Но при необходимос-
ти файл может читаться или записываться в любом произвольном
порядке. Обращение к системе с помощью функции lseek позво-
ляет передвигаться по файлу, не производя фактического чте-
ния или записи. В результате обращения

 lseek(fd,offset,origin);

текущая позиция в файле с дескриптором fd передвигается на
позицию offset (смещение), которая отсчитывается от места,
указываемого аргументом origin (начало отсчета). Последующее
чтение или запись будут теперь начинаться с этой позиции.
Аргумент offset имеет тип long; fd и origin имеют тип int.
Аргумент origin может принимать значения 0, 1 или 2, указывая
на то, что величина offset должна отсчитываться соответст-
венно от начала файла, от текущей позиции или от конца фай-
ла. Например, чтобы дополнить файл, следует перед записью
найти его конец:

 lseek(fd,0L,2);

чтобы вернуться к началу ("перемотать обратно"), можно напи-
сать:

 lseek(fd,0L,0);

обратите внимание на аргумент 0L; его можно было бы записать
и в виде (long) 0.
    Функция lseek позволяет обращаться с файлами примерно
так же, как с большими массивами, правда ценой более медлен-
ного доступа. Следующая простая функция, например, считывает
любое количество байтов, начиная с произвольного места в
файле.

get(fd,pos,buf,n) /*read n bytes from position pos*/
int fd, n;
long pos;
char *buf;
{
  lseek(fd,pos,0); /*get to pos*/
  return(read(fd,buf,n));
}

    В более ранних редакциях, чем редакция 7 системы UNIX,
основная точка входа в систему ввода-вывода называется seek.
Функция seek идентична функции lseek, за исключением того,
что аргумент offset имеет тип int, а не long. в соответствии
с этим, поскольку на PDP-11 целые имеют только 16 битов, ар-
гумент offset, указываемый функции seek, ограничен величиной
65535; по этой причине аргумент origin может иметь значения
3, 4, 5, которые заставляют функцию seek умножить заданное
значение offset на 512 (количество байтов в одном физическом
блоке) и затем интерпретировать origin, как если это 0, 1
или 2 соответственно. Следовательно, чтобы достичь произ-
вольного места в большом файле, нужно два обращения к seek:
сначала одно, которое выделяет нужный блок, а затем второе,
где origin имеет значение 1 и которое осуществляет передви-
жение на желаемый байт внутри блока.

Упражнение 8-2
    Очевидно, что seek может быть написана в терминалах
lseek и наоборот. Напишите каждую функцию через другую.</pre>
	<script  language=JavaScript  src="../footer.js"></script>
	</body>
	
</html>
